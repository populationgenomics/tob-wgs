---
author: "Centre for Population Genomics"
date: "`r as.character(paste(Sys.time(), Sys.timezone()))`"
output:
  html_document:
    theme: cosmo
    toc: true
    code_download: true
    code_folding: show
  rmdformats::material:
    highlight: kate
params:
  title: "TOB-WGS Plink SNPchip Sex Check"
  input_plink_fam: "snpchip/v1/plink/onek1k.fam"
  input_sex_meta: "reported_sex.tsv"
title: "`r paste(params$title)`"
---

```{r knitr_opts, include=F}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Introduction

We were provided with Plink `bed/bim/fam` files from the SNPchip data in
2021-Jul-20. These were generated using GenomeStudio and its Plink
plugin. The GRCh37 human genome assembly was used.

The TOB sample IDs were originally given to the participants at the time of
blood collection. The genotype platform generated new IDs for the cohort which
were required in the Plink files (Family and Individual IDs (FID and IID)),
and a new key ID was generated by combining `FID_IID` (e.g. `1_1`, `2_2`).

Here we're comparing the sex labels between the original metadata provided to
CPG and the SNPchip-specific metadata (provided to GWCCG).

## Exploration

```{r load_pkgs}
require(DT)
require(glue)
require(knitr)
require(sessioninfo)
require(tidyverse)
```

- Copying inputs to container:

```{r setup_inputs}
plink_fam_gcs <- params$input_plink_fam
plink_fam <- basename(plink_fam_gcs)
sex_meta_gcs <- params$input_sex_meta
sex_meta <- basename(sex_meta_gcs)

# copy inputs to container
system(glue("gsutil cp {plink_fam_gcs} {sex_meta_gcs} ."))
```

- Get Plink sample names:

```{r snpchip_vcf_stats}
read_plink_fam <- function(x) {
  read_table2(x, col_names = c("FamID", "IndID", "PatID", "MatID", "Sex", "Aff"),
              col_types = cols(.default = "c"))
}

fam <-
  read_plink_fam(plink_fam) %>%
  select(FamID, IndID, Sex) %>%
  mutate(FamIndID = glue("{FamID}_{IndID}"))
```

## Sex check

```{r}
sex <- sex_meta %>%
  read_tsv(skip = 2,
           col_names = c("IndID", "TOBID", "Sex_cpg",
                         paste0("nanodrop_", c("conc", "260/280", "230/280")),
                         paste0("qubit_", c("assay_conc", "stock_conc")),
                         "volume", "location")) %>%
  filter(!is.na(IndID)) %>%
  select(IndID, TOBID, Sex_cpg) %>%
  mutate(IndID = as.character(IndID))

swaps <- sex %>%
  left_join(fam) %>%
  mutate(Sex = if_else(Sex == 1, "M", if_else(Sex == 2, "F", "Other"))) %>%
  mutate(x = Sex == Sex_cpg) %>%
  filter(x %in% c(NA, FALSE))

swaps %>%
  datatable(rownames = TRUE,
            caption = "Samples with sex label discrepancy.",
            class = "cell-border display compact",
            filter = list(position = "top", clear = FALSE, plain = TRUE),
            extensions = c("Scroller", "KeyTable", "Buttons"),
            options = list(scroller = TRUE, scrollX = TRUE, scrollY = 700,
                           buttons = 'csv', keys = TRUE, dom = "Blfrtip"))
```

-------------------------

## Session Info

```{r session_info, echo=FALSE}
si <- session_info(include_base = TRUE)
si_pl <- unclass(si$platform) %>% as_tibble() %>% t()
si_pkg <- unclass(si$packages) %>%
  as_tibble() %>%
  select(package, version = ondiskversion, datestamp = date)

si_pkg %>%
  datatable(filter = list(position = "top", clear = FALSE, plain = TRUE),
            rownames = FALSE, extensions = c("Scroller"),
            options = list(scroller = TRUE, scrollX = TRUE, scrollY = 400,
                           dom = 'frtip'))

tibble(var = rownames(si_pl),
       value = si_pl[, , drop = TRUE]) %>%
  kable(caption = "Platform information.")
```
